# M3U8パッケージのテスト仕様

## 概要

M3U8パッケージのテストは、HLSストリーミングで使用されるM3U8プレイリストの操作に関する機能をカバーしています。
テストは主に以下の機能を検証します：

- プレイリストの読み込みと解析
- プレイリストの作成と書き込み
- セグメント管理
- シーケンス番号の制御
- パス変換処理
- データ型変換

## テストファイル構成

### テストケースファイル

`testdata/` ディレクトリに以下のテストファイルが配置されています：

- `basic.m3u8`: 基本的なM3U8ファイル
- `max_segments.m3u8`: 最大セグメント数を含むファイル
- `discontinuity.m3u8`: DISCONTINUITYタグを含むファイル
- `invalid_header.m3u8`: 不完全なヘッダーを持つファイル
- `invalid_extinf.m3u8`: 不正なEXTINF値を含むファイル
- `invalid_sequence.m3u8`: 不正なシーケンス番号を含むファイル
- `empty.m3u8`: 最小限のヘッダーのみのファイル
- `special_chars.m3u8`: 特殊文字を含むパスを持つファイル

## テスト機能

### 1. TestLoadM3U8

M3U8ファイルの読み込みと解析をテストします。

**テストケース**:
- 基本的なM3U8ファイルの読み込み
- 最大セグメント数のファイル読み込み
- DISCONTINUITYタグを含むファイルの読み込み
- 不正なフォーマットのファイル読み込み
- 存在しないファイルの処理

### 2. TestNewM3U8

新規M3U8ファイルの作成機能をテストします。

**検証項目**:
- デフォルトヘッダーの正確性
- メディアシーケンス番号の初期化
- DISCONTINUITYシーケンス番号の初期化

### 3. TestPlaylist_Update

プレイリストの更新処理をテストします。

**テストケース**:
- 初期セグメントの追加
- 2番目のセグメントペアの追加
- 最大セグメント数到達時の更新処理
- セグメントの削除と追加の整合性

**検証項目**:
- tsCountの正確性
- wait値の計算
- セグメントの順序
- DISCONTINUITYタグの処理

### 4. TestSequenceIncrement

シーケンス番号の更新処理をテストします。

**テストケース**:
- 正常なシーケンス番号の増加
- DISCONTINUITYシーケンス番号の増加
- 不正なシーケンス番号の処理

### 5. TestGetTagFloat

タグから数値を取得する機能をテストします。

**テストケース**:
- 正常なEXTINF値の解析
- 不正な値の処理
- 異なるタグの処理

### 6. TestConvertM3U8LineSlice

m3u8Line型のスライスを文字列スライスに変換する機能をテストします。

**テストケース**:
- 空のスライス変換
- 1要素のスライス変換
- 複数要素のスライス変換
- 特殊文字を含む要素の変換
- 大きなスライス（100要素）の変換

**検証項目**:
- 変換後の文字列内容
- スライスの容量最適化
- メモリ使用効率

### 7. TestRewriteTsPath

TSファイルのパス変換機能をテストします。クロスプラットフォームでの動作を保証します。

**テストケース**:
1. 基本パターン
   - 通常のTSファイル
   - サブディレクトリ内のファイル
   - 同一ディレクトリ内のファイル

2. 相対パスパターン
   - 親ディレクトリへの参照 (../segments/file.ts)
   - カレントディレクトリ参照 (./file.ts)
   - 複雑な相対パス (../../dir/file.ts)

3. 特殊パスパターン
   - スペースを含むパス
   - 日本語を含むパス
   - 特殊文字(#等)を含むパス
   - ベースディレクトリ外のパス

**検証項目**:
- パスの正規化
- プラットフォーム依存文字の変換
- 相対パスの解決
- /srv/radioプレフィックスの処理

## テストの実行方法

1. go-serverディレクトリに移動:
```bash
cd go-server
```

2. テストの実行:
```bash
go test ./internal/hls/
```

3. 詳細なテスト結果の表示:
```bash
go test -v ./internal/hls/
```

## エッジケース

以下のエッジケースがテストでカバーされています：

1. ファイル操作関連
   - 存在しないファイルへのアクセス
   - 特殊文字を含むパス
   - 空のファイル

2. フォーマット関連
   - 不完全なヘッダー
   - 不正なタグ値
   - 無効なシーケンス番号

3. プレイリスト操作
   - 最大セグメント数の制限
   - セグメント削除時のシーケンス番号の更新
   - DISCONTINUITYタグの付与と削除

4. パス変換関連
   - クロスプラットフォームパス区切り文字
   - 絶対パスと相対パスの混在
   - 特殊文字や日本語を含むパス
   - パスの正規化エッジケース

## 注意事項

- テストファイルは `testdata/` ディレクトリに配置する必要があります
- テスト実行前にテストファイルが正しく配置されていることを確認してください
- エラーログはslog.Errorで出力されます
- パステストはWindows/Linux両環境で動作確認が必要
- パスの区切り文字は自動的に正規化されます
