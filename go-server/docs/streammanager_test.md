# StreamManagerのテスト仕様

## 概要

StreamManagerのテストは、HLSストリーミングのプレイリスト管理機能をカバーしています。
特に以下の機能を検証します：

- 初期化と状態管理
- コンテンツの追加と更新
- 並行処理の安全性
- エッジケースの処理

## テストケース

### 1. TestNewStreamM3U8Manager

マネージャーの初期化機能をテストします。

**テストケース**:
- 正常系：有効なパスでの初期化
- 異常系：無効なベースディレクトリ（初期化時点ではエラーにならない）

**検証項目**:
- 各種チャネルの初期化
- ベースディレクトリとストリームファイルパスの設定
- プレイリストの初期化

### 2. TestStreamManagerOperations

基本的な操作シーケンスをテストします。

**テストケース**:
- 基本的な操作シーケンス（Run, Add, Add, Stop）
- 早期Stop（実行直後の停止）
- 不正なコンテンツの追加

**検証項目**:
- ステータスの遷移
- エラーハンドリング
- リソースの適切な解放

### 3. TestStreamManagerConcurrency

並行処理の安全性をテストします。

**テストケース**:
- 複数の同時Add（5個のコンテンツ）
- 高頻度のAdd（10個のコンテンツ）

**注意事項**:
- 現在の実装では実行に約60秒かかります
- 主な待機時間:
  - 複数の同時Add: 30秒
  - 高頻度のAdd: 30秒
- パフォーマンス改善の余地があります：
  1. SyncFromSourceの待機時間の最適化
  2. テスト用の同期間隔制御機能の追加
  3. 並行処理テストの待機時間の調整

### 4. TestStreamManagerEdgeCases

エッジケースと特殊な状況をテストします。

**テストケース**:
- Stop前のAdd操作
- 二重Stop
- Stop後のAdd操作

**検証項目**:
- 状態の一貫性
- エラーの適切な処理
- デッドロックの防止

## テストデータ

テスト実行時に以下のファイルが一時ディレクトリに作成されます：

1. メインのストリームファイル
- stream.m3u8 (出力ファイル)

2. コンテンツソースファイル
- contents/music/[id]/[id].m3u8 (入力ファイル)

## テスト実行の構成

### 1. セットアップ
```go
func setupTest(t *testing.T) (string, func())
```
- 一時ディレクトリの作成
- テストファイルの生成
- クリーンアップ関数の提供

### 2. コンテンツ管理
- 各テストケースで独立したコンテンツディレクトリ
- テスト用M3U8ファイルの動的生成

### 3. 並行処理テスト
- goroutineによる同時実行
- WaitGroupによる同期
- タイミング制御用のsleep

## 実装上の課題

1. **実行時間の問題**
   - TestStreamManagerConcurrencyの実行に60秒以上必要
   - 主にSyncFromSourceの待機時間に起因
   - テスト環境での待機時間の制御が必要

2. **並行処理のテスト改善案**
   - テスト用の同期間隔制御インターフェースの追加
   - mockによる時間依存の分離
   - テストケース単位での待機時間調整

3. **エラー処理の検証**
   - ファイル操作エラーのシミュレーション
   - チャネル操作のエッジケース
   - リソースリークの防止

## 注意事項

- テスト実行前に十分なディスク容量があることを確認
- 一時ファイルの自動クリーンアップを確認
- 並行処理テストは環境依存の可能性あり
- エラーログはslog.Errorで出力
